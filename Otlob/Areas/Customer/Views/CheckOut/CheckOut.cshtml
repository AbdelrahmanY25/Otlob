@model CheckOutResponse

@{
    ViewData["Title"] = "Checkout";
    var totalAmount = Model.SubTotal + Model.DeliveryFee + Model.ServiceFee;
}

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/checkout.css" />

<div class="checkout-page">
    <div class="container">
        <div style="margin-bottom: 20px;">
             <a href="@Url.Action("Cart", "Cart", new { area = "Customer" })" 
             style="display:inline-flex;align-items:center;gap:8px;color:var(--text-secondary);text-decoration:none;font-weight:600;">
                <i class="bi bi-arrow-left"></i> Back to Cart
            </a>
        </div>

        <form asp-controller="Order" asp-action="PlaceOrder" method="post" id="checkoutForm">
            <div class="checkout-container">
                <!-- Left Column -->
                <div class="checkout-main">
                    <!-- Delivery Address -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="bi bi-geo-alt"></i> Delivery Address
                        </div>
                        
                        <div class="address-content">
                            <span class="address-type-badge">@Model.Address.PlaceType</span>
                            
                            <!-- Map Placeholder -->
                            <div class="map-container" id="map" data-lat="@Model.Address.LatCode" data-lng="@Model.Address.LonCode"></div>                            
                            
                            <h5 class="mb-2 mt-2">@Model.Address.StreetName, @Model.Address.HouseNumberOrName</h5>
                            
                            @if (Model.Address.FloorNumber.HasValue)
                            {
                                <p class="text-muted mb-1">Floor: @Model.Address.FloorNumber</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.Address.CompanyName))
                            {
                                <p class="text-muted mb-1">Company: @Model.Address.CompanyName</p>
                            }
                            <p class="text-muted mb-0">@Model.Address.CustomerAddress</p>

                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="bi bi-credit-card text-danger"></i> Payment Method
                        </div>
                        
                        <div class="payment-options">
                            <label class="payment-option selected" onclick="selectPayment(this)">
                                <input type="radio" name="paymentMethod" value="@PaymentMethod.Cash" checked>
                                <i class="bi bi-cash-stack payment-icon"></i>
                                <div>
                                    <div style="font-weight:600;">Cash on Delivery</div>
                                    <div style="font-size:0.85rem; color:var(--text-secondary);">Pay when you receive your order</div>
                                </div>
                            </label>
                            
                            <label class="payment-option" onclick="selectPayment(this)">
                                <input type="radio" name="paymentMethod" value="@PaymentMethod.Credit">
                                <i class="bi bi-credit-card-2-front payment-icon"></i>
                                <div>
                                    <div style="font-weight:600;">Credit Card</div>
                                    <div style="font-size:0.85rem; color:var(--text-secondary);">Pay securely with your credit card</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Special Notes -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="bi bi-pencil-square text-danger"></i> Special Notes
                        </div>
                        <div class="form-group">
                            <textarea name="specialNotes" class="form-control" rows="3" placeholder="Any special instructions for delivery or food preparation? (Optional)" style="resize: none; border-color: var(--border-light);"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="checkout-sidebar">
                    <div class="section-card" style="position:sticky; top: 20px;">
                        <div class="section-title">Order Summary</div>
                        
                        <div class="delivery-time">
                            <i class="bi bi-clock-history"></i>
                            <span>Estimated delivery: @Model.DeliveryTime mins</span>
                        </div>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>@Model.SubTotal.ToString("N2") L.E</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>@Model.DeliveryFee.ToString("N2") L.E</span>
                        </div>
                        
                        <div class="summary-row">
                            <span style="display:flex; align-items:center;">
                                Service Fee 
                                <i class="bi bi-info-circle info-icon" data-bs-toggle="modal" data-bs-target="#feesModal"></i>
                            </span>
                            <span>@Model.ServiceFee.ToString("N2") L.E</span>
                        </div>

                        <div class="summary-row total">
                            <span>Total Amount</span>
                            <span class="text-danger">@totalAmount.ToString("N2") L.E</span>
                        </div>

                        <button type="submit" class="place-order-btn">
                            Place Order
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Fees Details Modal -->
<div class="modal fade" id="feesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fs-6 fw-bold">Fee Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    Service fees help us operate the platform and provide 24/7 customer support for your orders.
                </p>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Platform Fee</span>
                    <span>@((Model.ServiceFee * 0.6m).ToString("N2")) L.E</span>
                </div>
                <div class="d-flex justify-content-between small">
                    <span>Tax & Processing</span>
                    <span>@((Model.ServiceFee * 0.4m).ToString("N2")) L.E</span>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between fw-bold small">
                    <span>Total Service Fee</span>
                    <span>@Model.ServiceFee.ToString("N2") L.E</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="~/js/checkout.js" defer></script>
