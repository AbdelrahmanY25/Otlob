@model ChangePasswordRequest

@{ ViewData["Title"] = "Change Password"; }

<link href="~/css/authForms.css" rel="stylesheet" asp-append-version="true"/>

<div class="auth-wrapper">
    <div class="auth-card">
        <div class="auth-header">
            <a href="/" class="auth-logo">Otlob<span>.</span></a>
            <h1>Change Password</h1>
            <p>Enter your current password and set a new one.</p>
        </div>

        <form asp-action="ChangePassword" class="auth-form">
            <div asp-validation-summary="ModelOnly" class="auth-alert auth-alert-error" style="display:none;"></div>

            <div class="auth-form-group">
                <label class="auth-label" asp-for="CurrentPassword">Current Password</label>
                <div class="auth-input-container">
                    <input type="password" id="currentPassword" class="auth-input" asp-for="CurrentPassword" placeholder="Enter your current password" />
                    <i class="fas fa-lock auth-input-icon"></i>
                    <button type="button" class="auth-password-toggle" onclick="togglePassword('currentPassword', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="CurrentPassword" class="auth-input-error"></span>
            </div>

            <div class="auth-form-group">
                <label class="auth-label" asp-for="NewPassword">New Password</label>
                <div class="auth-input-container">
                    <input type="password" id="newPassword" class="auth-input" asp-for="NewPassword" placeholder="Enter the new password" />
                    <i class="fas fa-lock auth-input-icon"></i>
                    <button type="button" class="auth-password-toggle" onclick="togglePassword('newPassword', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <div class="password-meter-container">
                    <div class="password-meter">
                        <div class="meter-segment" id="seg-1"></div>
                        <div class="meter-segment" id="seg-2"></div>
                        <div class="meter-segment" id="seg-3"></div>
                        <div class="meter-segment" id="seg-4"></div>
                        <div class="meter-segment" id="seg-5"></div>
                    </div>
                    <div class="password-criteria">
                        <span class="criteria-item" id="crit-len"><i class="fas fa-circle"></i> 8+ chars</span>
                        <span class="criteria-item" id="crit-cap"><i class="fas fa-circle"></i> 1 upper</span>
                        <span class="criteria-item" id="crit-low"><i class="fas fa-circle"></i> 1 lower</span>
                        <span class="criteria-item" id="crit-num"><i class="fas fa-circle"></i> 1 number</span>
                        <span class="criteria-item" id="crit-spec"><i class="fas fa-circle"></i> 1 special</span>
                    </div>
                </div>

                <span asp-validation-for="NewPassword" class="auth-input-error"></span>
            </div>

            <div class="auth-form-group">
                <label class="auth-label" asp-for="ConfirmNewPassword">Confirm New Password</label>
                <div class="auth-input-container">
                    <input type="password" id="confirmNewPassword" class="auth-input" asp-for="ConfirmNewPassword" placeholder="Confirm the new password" />
                    <i class="fas fa-lock auth-input-icon"></i>
                    <button type="button" class="auth-password-toggle" onclick="togglePassword('confirmNewPassword', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="ConfirmNewPassword" class="auth-input-error"></span>
            </div>

            <button type="submit" class="auth-btn">Change Password</button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial"></partial>
    <partial name="_NotificationPartial"></partial>
    
    <script>
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password Meter Logic
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('newPassword');
            const segments = document.querySelectorAll('.meter-segment');
            const criteriaItems = {
                len: document.getElementById('crit-len'),
                cap: document.getElementById('crit-cap'),
                low: document.getElementById('crit-low'),
                num: document.getElementById('crit-num'),
                spec: document.getElementById('crit-spec')
            };

            if(passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const val = this.value;
                    let score = 0;
                        
                    // Check conditions
                    const conditions = {
                        len: val.length >= 8,
                        cap: /[A-Z]/.test(val),
                        low: /[a-z]/.test(val),
                        num: /[0-9]/.test(val),
                        spec: /[^A-Za-z0-9]/.test(val)
                    };

                    // Update text criteria status
                    for (const [key, met] of Object.entries(conditions)) {
                        if (met) {
                            criteriaItems[key].classList.add('valid');
                            criteriaItems[key].querySelector('i').classList.replace('fa-circle', 'fa-check-circle');
                            score++;
                        } else {
                            criteriaItems[key].classList.remove('valid');
                            criteriaItems[key].querySelector('i').classList.replace('fa-check-circle', 'fa-circle');
                        }
                    }

                    // Update visual meter segments (0 to 5)
                    segments.forEach((seg, index) => {
                        if (index < score) {
                            seg.classList.add('active');
                        } else {
                            seg.classList.remove('active');
                        }
                    });
                });
            }
        });
    </script>
}