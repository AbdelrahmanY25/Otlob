@model MealResponnse

<link rel="stylesheet" href="~/css/addMeal.css" asp-append-version="true" />

<div class="am-page">
    <div class="am-container">
        <div class="am-header">
            <a asp-action="Index" class="am-back-btn" title="Back to Meals">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="am-header-content">
                <h1>Edit Meal</h1>
                <p>Update meal details and image</p>
            </div>
        </div>

        <div class="am-card">
            <div class="am-card-header">
                <h2>
                    <i class="fas fa-utensils"></i>
                    Meal Details
                </h2>
            </div>

            <div class="am-card-body">
                <div class="am-form-layout">
                    <form asp-action="UpdateImage" asp-route-key="@Model.Key" method="post" enctype="multipart/form-data">
                        <div class="am-image-section">
                            <div class="am-image-upload">
                                <div class="am-image-preview" onclick="document.getElementById('fileInputImage').click()">
                                    <img id="mealLogo" src="/images/@(Model.Image ?? "Default.jpg")" alt="Meal Image" />
                                    <div class="am-image-overlay">
                                        <i class="fas fa-camera"></i>
                                        <span>Change Image</span>
                                    </div>
                                </div>
                                <input class="am-file-input" id="fileInputImage" type="file" accept="image/*" name="Image" onchange="previewImage(this)" />
                            </div>
                            <p class="am-image-hint"><i class="fas fa-info-circle"></i> Click to upload meal image (JPG, PNG)</p>
                            <div style="margin-top:12px; display:flex; gap:8px;">
                                <button type="submit" class="am-submit-btn" style="flex:unset; padding:10px 18px;"><i class="fas fa-image"></i> Save Image</button>
                            </div>
                        </div>
                    </form>

                    <form asp-action="Update" asp-route-key="@Model.Key" method="post">
                        <div class="am-fields-section">
                            <div class="am-form-group">
                                <label asp-for="Name" class="am-form-label"><i class="fas fa-tag"></i> Meal Name <span class="required">*</span></label>
                                <input asp-for="Name" class="am-form-input" value="@Model.Name" />
                            </div>

                            <div class="am-form-group">
                                <label asp-for="Description" class="am-form-label"><i class="fas fa-align-left"></i> Description</label>
                                <textarea asp-for="Description" class="am-form-textarea">@Model.Description</textarea>
                            </div>

                            <div class="am-form-row">
                                <div class="am-form-group">
                                    <label asp-for="Price" class="am-form-label"><i class="fas fa-dollar-sign"></i> Price <span class="required">*</span></label>
                                    <input asp-for="Price" type="number" step="0.01" min="0" class="am-form-input" value="@Model.Price" />
                                </div>

                                <div class="am-form-group">
                                    <label asp-for="NumberOfServings" class="am-form-label"><i class="fas fa-users"></i> Servings</label>
                                    <div class="am-number-wrapper">
                                        <button type="button" class="am-number-btn" onclick="decrementServings()"><i class="fas fa-minus"></i></button>
                                        <input asp-for="NumberOfServings" type="number" id="NumberOfServings" class="am-number-input" value="@Model.NumberOfServings" min="1" max="20" readonly />
                                        <button type="button" class="am-number-btn" onclick="incrementServings()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="am-toggles-section">
                                <label class="am-toggle-card" id="availableCard">
                                    <div class="am-toggle-wrapper">
                                        <input asp-for="IsAvailable" type="checkbox" value="true" class="am-toggle-checkbox" onchange="toggleCard('availableCard', this.checked)" />
                                        <div class="am-toggle-switch"></div>
                                        <div class="am-toggle-content">
                                            <span class="am-toggle-label">Available</span>
                                            <span class="am-toggle-hint">Make meal available to customers</span>
                                        </div>
                                    </div>
                                </label>

                                <label class="am-toggle-card" id="newMealCard">
                                    <div class="am-toggle-wrapper">
                                        <input asp-for="IsNewMeal" type="checkbox" value="true" class="am-toggle-checkbox" onchange="toggleCard('newMealCard', this.checked)" />
                                        <div class="am-toggle-switch"></div>
                                        <div class="am-toggle-content">
                                            <span class="am-toggle-label">New Meal</span>
                                            <span class="am-toggle-hint">Mark as newly added</span>
                                        </div>
                                    </div>
                                </label>

                                <label class="am-toggle-card" id="trendingMealCard">
                                    <div class="am-toggle-wrapper">
                                        <input asp-for="IsTrendingMeal" type="checkbox" value="true" class="am-toggle-checkbox" onchange="toggleCard('trendingMealCard', this.checked)" />
                                        <div class="am-toggle-switch"></div>
                                        <div class="am-toggle-content">
                                            <span class="am-toggle-label">Trending</span>
                                            <span class="am-toggle-hint">Show in trending section</span>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div class="am-category-section">
                                <div class="am-category-label"><i class="fas fa-layer-group"></i> Select Category</div>
                                <select asp-for="CategoryKey" class="am-category-select">
                                    <option value="" disabled>Choose a category...</option>
                                    @foreach (var c in Model.Categories!)
                                    {
                                        if (c.Key == Model.CategoryKey)
                                        {
                                            <option value="@c.Key" selected>@c.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@c.Key">@c.Name</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="am-submit-section">
                                <button type="submit" class="am-submit-btn"><i class="fas fa-save"></i> Save Changes</button>
                                <a asp-action="Index" class="am-cancel-btn"><i class="fas fa-times"></i> Cancel</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_NotificationPartial" />

    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('mealLogo').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function incrementServings() {
            const input = document.getElementById('NumberOfServings');
            const currentValue = parseInt(input.value) || 1;
            if (currentValue < 20) input.value = currentValue + 1;
        }

        function decrementServings() {
            const input = document.getElementById('NumberOfServings');
            const currentValue = parseInt(input.value) || 1;
            if (currentValue > 1) input.value = currentValue - 1;
        }

        function toggleCard(cardId, isChecked) {
            const card = document.getElementById(cardId);
            if (!card) return;
            if (isChecked) card.classList.add('active'); else card.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function () {
            ['IsAvailable', 'IsNewMeal', 'IsTrendingMeal'].forEach(function (name) {
                var el = document.querySelector('input[name="' + name + '"]');
                if (el && el.checked) {
                    var id = name === 'IsAvailable' ? 'availableCard' : (name === 'IsNewMeal' ? 'newMealCard' : 'trendingMealCard');
                    toggleCard(id, true);
                }
            });
        });
    </script>
}
