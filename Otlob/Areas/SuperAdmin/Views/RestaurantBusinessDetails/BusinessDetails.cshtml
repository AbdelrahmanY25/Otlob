@model RestaurantBusinessInfo

@{
    ViewData["Title"] = "Business Details";
}

<link rel="stylesheet" href="~/css/adminProfile.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/adminCategorySelector.css" asp-append-version="true" />

<div class="profile-container">

     <div class="profile-header-card" style="padding: 20px; gap: 20px;">
        <div style="font-size: 32px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--adm-primary-light); color: var(--adm-primary); border-radius: 12px;">
            <i class="fas fa-briefcase"></i>
        </div>
        <div class="profile-info">
            <h1>Business Details</h1>
            <div class="profile-email">
                Manage your delivery settings, operating hours, and business classification.
            </div>
        </div>
    </div>

    <div class="profile-content-card">
        <form asp-action="Update" method="post">
            <div asp-validation-summary="All" class="text-danger mb-4"></div>

            <!-- Delivery Settings -->
            <div class="card-header" style="margin-top: 0;">
                <h2><i class="fas fa-truck" style="margin-right: 10px; color: var(--adm-primary);"></i> Delivery Settings</h2>
            </div>
            
            <div class="profile-form-grid" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label asp-for="DeliveryFee" class="form-label">Delivery Fee</label>
                    <div class="input-wrapper">
                        <i class="fas fa-money-bill-wave"></i>
                        <input asp-for="DeliveryFee" class="form-input" type="number" step="0.01" min="0" placeholder="0.00" />
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="DeliveryDurationTime" class="form-label">Delivery Duration (min)</label>
                    <div class="input-wrapper">
                        <i class="fas fa-stopwatch"></i>
                        <input asp-for="DeliveryDurationTime" class="form-input" type="number" min="1" placeholder="e.g. 30" />
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="MinimumOrderPrice" class="form-label">Minimum Order Price</label>
                    <div class="input-wrapper">
                        <i class="fas fa-tag"></i>
                        <input asp-for="MinimumOrderPrice" class="form-input" type="number" step="0.01" min="0" placeholder="0.00" />
                    </div>
                </div>
                 <div class="form-group">
                    <label asp-for="NumberOfBranches" class="form-label">Number of Branches</label>
                    <div class="input-wrapper">
                        <i class="fas fa-code-branch"></i>
                        <input asp-for="NumberOfBranches" class="form-input" type="number" min="1" max="500" placeholder="1" />
                    </div>
                </div>
            </div>

            <!-- Operating Hours -->
            <div class="card-header">
                <h2><i class="fas fa-clock" style="margin-right: 10px; color: var(--adm-primary);"></i> Operating Hours</h2>
            </div>

            <div class="profile-form-grid" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label asp-for="OpeningTime" class="form-label">Opening Time</label>
                    <div class="input-wrapper">
                        <i class="far fa-clock"></i>
                        <input asp-for="OpeningTime" class="form-input" type="time" />
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="ClosingTime" class="form-label">Closing Time</label>
                    <div class="input-wrapper">
                        <i class="fas fa-moon"></i>
                        <input asp-for="ClosingTime" class="form-input" type="time" />
                    </div>
                </div>
            </div>

            <!-- Business Information -->
             <div class="card-header">
                <h2><i class="fas fa-building" style="margin-right: 10px; color: var(--adm-primary);"></i> Business Info</h2>
            </div>

            <div class="profile-form-grid" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label asp-for="BusinessType" class="form-label">Business Type</label>
                     <div class="input-wrapper">
                        <i class="fas fa-utensils" style="z-index: 1;"></i>
                        <select asp-for="BusinessType" class="form-input" asp-items="Html.GetEnumSelectList<BusinessType>()"></select>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="AdministratorRole" class="form-label">Administrator Role</label>
                     <div class="input-wrapper">
                        <i class="fas fa-user-shield" style="z-index: 1;"></i>
                        <select asp-for="AdministratorRole" class="form-input" asp-items="Html.GetEnumSelectList<AdministratorRole>()"></select>
                    </div>
                </div>
            </div>

             <!-- Restaurant Categories -->
            <div class="card-header">
                <h2><i class="fas fa-list" style="margin-right: 10px; color: var(--adm-primary);"></i> Restaurant Categories</h2>
            </div>
            
            <div class="profile-form-grid" style="grid-template-columns: 1fr;">
                 <div class="category-selector-container">
                    <label class="category-selector-label">
                        Select Categories
                        <span class="max-hint">Max 3</span>
                    </label>

                    <div class="selected-categories" id="selectedCategories">
                        @if (Model.RestaurantCategories != null && Model.RestaurantCategories.Any())
                        {
                            @foreach (var category in Model.RestaurantCategories)
                            {
                                <div class="category-tag" data-id="@category.Id">
                                    <span>@category.Name</span>
                                    <button type="button" class="remove-tag" onclick="removeCategory(@category.Id)">×</button>
                                </div>
                            }
                        }
                        else
                        {
                            <span class="selected-categories-placeholder">No categories selected</span>
                        }
                    </div>

                    <div class="category-dropdown-wrapper">
                        <div class="category-dropdown-trigger" id="dropdownTrigger" onclick="toggleDropdown()">
                            <span class="dropdown-trigger-text" id="triggerText">Select categories...</span>
                            <span class="dropdown-trigger-icon"><i class="fas fa-chevron-down"></i></span>
                        </div>

                        <div class="category-dropdown-menu" id="dropdownMenu">
                            <div class="dropdown-search">
                                <input type="text" id="categorySearch" placeholder="🔍 Search categories..." oninput="filterCategories()" />
                            </div>
                            <div class="dropdown-options-wrapper">
                                <div class="dropdown-options" id="dropdownOptions">
                                    @if (Model.AllCategories != null)
                                    {
                                        @foreach (var category in Model.AllCategories)
                                        {
                                            var isSelected = Model.RestaurantCategories?.Any(c => c.Id == category.Id) ?? false;
                                            <div class="dropdown-option @(isSelected ? "selected" : "")" 
                                                 data-id="@category.Id" 
                                                 data-name="@category.Name"
                                                 onclick="toggleCategory(@category.Id, '@category.Name')">
                                                <div class="option-icon">
                                                    <i class="fas fa-utensils"></i>
                                                </div>
                                                <span class="option-text">@category.Name</span>
                                                <div class="option-check">✓</div>
                                            </div>
                                        }
                                    }
                                </div>
                                <div class="dropdown-empty" id="dropdownEmpty" style="display: none;">
                                    <i class="fas fa-search"></i>
                                    No categories found
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="category-hidden-inputs" id="categoryInputs">
                        @if (Model.RestaurantCategories != null)
                        {
                            @foreach (var category in Model.RestaurantCategories)
                            {
                                <input type="hidden" name="SelectedCategoryIds" value="@category.Id" />
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="profile-btn">
                    <i class="fas fa-save"></i> Update Business Details
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_NotificationPartial" />

    <script>
        // State management
        const maxCategories = 3;
        let selectedCategories = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial selected categories
            const initialTags = document.querySelectorAll('.category-tag');
            initialTags.forEach(tag => {
                const nameSpan = tag.querySelector('span');
                if (nameSpan) {
                    selectedCategories.push({
                        id: parseInt(tag.dataset.id),
                        name: nameSpan.textContent
                    });
                }
            });

            updateUI();

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const wrapper = document.querySelector('.category-dropdown-wrapper');
                const menu = document.getElementById('dropdownMenu');
                if (wrapper && !wrapper.contains(e.target) && !menu.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Prevent form submission on Enter in search
            document.getElementById('categorySearch').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });

            // Handle window scroll and resize - reposition dropdown
            window.addEventListener('scroll', repositionDropdown, true);
            window.addEventListener('resize', repositionDropdown);
        });

        // Position dropdown relative to trigger
        function positionDropdown() {
            const trigger = document.getElementById('dropdownTrigger');
            const menu = document.getElementById('dropdownMenu');
            const rect = trigger.getBoundingClientRect();
            
            // Calculate position
            // Use absolute positioning relative to nearest positioned ancestor (the wrapper)
            // But if we want it to break out of overflow:hidden containers, we might need fixed positioning
            // For now, let's stick to standard flow within the wrapper which needs to not be hidden
            
            // Simple display toggle handled by class
        }

        function repositionDropdown() {
            // Not strictly needed if position:absolute is relative to wrapper and wrapper moves with page
        }

        // Toggle dropdown visibility
        function toggleDropdown() {
            const trigger = document.getElementById('dropdownTrigger');
            const menu = document.getElementById('dropdownMenu');

            if (trigger.classList.contains('disabled')) {
                return; // Don't open if disabled (max reached)
            }

            const isOpen = menu.classList.contains('open');
            
            if (isOpen) {
                closeDropdown();
            } else {
                trigger.classList.add('active');
                menu.classList.add('open');
                
                // Focus search input
                setTimeout(() => {
                    document.getElementById('categorySearch').focus();
                }, 100);
            }
        }

        function closeDropdown() {
            document.getElementById('dropdownTrigger').classList.remove('active');
            document.getElementById('dropdownMenu').classList.remove('open');
            document.getElementById('categorySearch').value = '';
            filterCategories(); // Reset filter
        }

        // Toggle category selection
        function toggleCategory(id, name) {
            event.stopPropagation(); // Prevent dropdown from closing
            
            const index = selectedCategories.findIndex(c => c.id === id);

            if (index > -1) {
                // Remove if already selected
                selectedCategories.splice(index, 1);
            } else {
                // Add if not at max
                if (selectedCategories.length < maxCategories) {
                    selectedCategories.push({ id, name });
                } else {
                    return; // Don't add if at max
                }
            }

            updateUI();
            
            // Close dropdown if max reached
            if (selectedCategories.length >= maxCategories) {
                closeDropdown();
            }
        }

        // Remove category from selection
        function removeCategory(id) {
            event.stopPropagation();
            selectedCategories = selectedCategories.filter(c => c.id !== id);
            updateUI();
        }

        // Filter categories in dropdown
        function filterCategories() {
            const searchValue = document.getElementById('categorySearch').value.toLowerCase();
            const options = document.querySelectorAll('.dropdown-option');
            let visibleCount = 0;

            options.forEach(option => {
                const name = option.dataset.name.toLowerCase();
                if (name.includes(searchValue)) {
                    option.style.display = 'flex';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });

            document.getElementById('dropdownEmpty').style.display = visibleCount === 0 ? 'block' : 'none';
        }

        // Update all UI elements
        function updateUI() {
            updateSelectedTags();
            updateDropdownOptions();
            updateHiddenInputs();
            updateTriggerState();
        }

        // Update the selected tags display
        function updateSelectedTags() {
            const container = document.getElementById('selectedCategories');
            container.innerHTML = '';

            if (selectedCategories.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'selected-categories-placeholder';
                placeholder.textContent = 'No categories selected';
                container.appendChild(placeholder);
                container.classList.remove('has-items');
            } else {
                selectedCategories.forEach(cat => {
                    const tag = document.createElement('div');
                    tag.className = 'category-tag';
                    tag.dataset.id = cat.id;
                    tag.innerHTML = `
                        <span>${cat.name}</span>
                        <button type="button" class="remove-tag" onclick="removeCategory(${cat.id})">×</button>
                    `;
                    container.appendChild(tag);
                });
                container.classList.add('has-items');
            }
        }

        // Update dropdown options state
        function updateDropdownOptions() {
            const options = document.querySelectorAll('.dropdown-option');
            const atMax = selectedCategories.length >= maxCategories;

            options.forEach(option => {
                const id = parseInt(option.dataset.id);
                const isSelected = selectedCategories.some(c => c.id === id);

                option.classList.toggle('selected', isSelected);
                option.classList.toggle('disabled', !isSelected && atMax);
            });
        }

        // Update hidden inputs for form submission
        function updateHiddenInputs() {
            const container = document.getElementById('categoryInputs');
            container.innerHTML = '';

            selectedCategories.forEach(cat => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'SelectedCategoryIds';
                input.value = cat.id;
                container.appendChild(input);
            });
        }

        // Update trigger button state
        function updateTriggerState() {
            const trigger = document.getElementById('dropdownTrigger');
            const triggerText = document.getElementById('triggerText');
            const atMax = selectedCategories.length >= maxCategories;

            trigger.classList.toggle('disabled', atMax);

            if (atMax) {
                triggerText.textContent = '✓ Maximum categories selected';
            } else {
                const remaining = maxCategories - selectedCategories.length;
                triggerText.textContent = `Select categories (${remaining} remaining)...`;
            }
        }
    </script>
}
