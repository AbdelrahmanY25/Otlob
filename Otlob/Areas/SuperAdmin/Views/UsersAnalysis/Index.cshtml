@model UsersAnalysisResponse

@{
	ViewData["Title"] = "Users Analytics";
	var topUsersData = Model.TopUsersByOrders.Select(u => new { name = u.UserName, orders = u.OrdersCount, spent = u.TotalSpent, image = u.UserImage }).ToList();
}

<link rel="stylesheet" href="~/css/usersAnalysis.css" asp-append-version="true" />

<div class="users-analytics-container">
	<!-- Header -->
	<div class="dashboard-header">
		<div class="header-content">
			<h1 class="dashboard-title">
				<i class="bi bi-people-fill me-2"></i>Users Analytics
			</h1>
			<p class="dashboard-subtitle">Overview of users activity and top users by orders</p>
		</div>
	</div>

	<!-- Stats Overview Cards -->
	<div class="stats-overview">
		<div class="stat-card primary clickable" data-href="@Url.Action("Customers", "Users", new { area = "SuperAdmin" })">
			<div class="stat-icon-wrapper">
				<i class="bi bi-people-fill"></i>
			</div>
			<div class="stat-info">
				<span class="stat-label">Total Users</span>
				<h3 class="stat-value" id="totalUsers">@Model.TotalUsers</h3>
			</div>
		</div>
		
		<div class="stat-card success">
			<div class="stat-icon-wrapper">
				<i class="bi bi-check-circle-fill"></i>
			</div>
			<div class="stat-info">
				<span class="stat-label">Active Users</span>
				<h3 class="stat-value" id="activeUsers">@Model.ActiveUsersCount</h3>
				<span class="stat-badge">@Model.ActivePercentage.ToString("N1")%</span>
			</div>
		</div>
		
		<!-- Repeat Customers - MOST IMPORTANT METRIC -->
		<div class="stat-card warning highlight">
			<div class="stat-icon-wrapper">
				<i class="bi bi-arrow-repeat"></i>
			</div>
			<div class="stat-info">
				<span class="stat-label">
					Repeat Customers
					<span class="key-metric-badge">KEY METRIC</span>
				</span>
				<h3 class="stat-value" id="repeatCustomers">@Model.RepeatCustomersCount</h3>
				<span class="stat-badge">@Model.RepeatCustomersPercentage.ToString("N1")%</span>
			</div>
		</div>
		
		<div class="stat-card danger">
			<div class="stat-icon-wrapper">
				<i class="bi bi-x-circle-fill"></i>
			</div>
			<div class="stat-info">
				<span class="stat-label">Inactive Users</span>
				<h3 class="stat-value" id="inactiveUsers">@Model.InactiveUsersCount</h3>
				<span class="stat-badge">@Model.InactivePercentage.ToString("N1")%</span>
			</div>
		</div>
		
		<div class="stat-card info">
			<div class="stat-icon-wrapper">
				<i class="bi bi-graph-up-arrow"></i>
			</div>
			<div class="stat-info">
				<span class="stat-label">Avg Orders / Active User</span>
				<h3 class="stat-value" id="avgOrders">@Model.AverageOrdersPerActiveUser</h3>
			</div>
		</div>
	</div>

	<!-- Charts and Top Users Row -->
	<div class="analytics-row">
		<div class="chart-card">
			<div class="chart-header">
				<h3 class="chart-title">
					<i class="bi bi-bar-chart-fill me-2"></i>Active vs Inactive Users
				</h3>
			</div>
			<div class="chart-body">
				<canvas id="activeBarChart" data-chart='@System.Text.Json.JsonSerializer.Serialize(new[]{ new { label = "Active", value = Model.ActiveUsersCount }, new { label = "Inactive", value = Model.InactiveUsersCount } })'></canvas>
			</div>
		</div>

		<div class="list-card">
			<div class="list-header">
				<h3 class="list-title">
					<i class="bi bi-trophy-fill text-warning me-2"></i>Top Users by Orders
				</h3>
				<input type="text" id="searchUser" class="search-input" placeholder="Search user...">
			</div>
			<div class="top-users" id="topUsersList">
				@if (Model.TopUsersByOrders.Any())
				{
					var rank = 1;
					foreach (var u in Model.TopUsersByOrders)
					{
						<a asp-area="SuperAdmin" asp-controller="UserProfile" asp-action="UserProfile" asp-route-id="@u.UserId" class="user-item" data-username="@u.UserName.ToLower()">
							<div class="rank-badge @(rank <= 3 ? $"rank-{rank}" : "")">@rank</div>
							<div class="user-avatar">
								@if (!string.IsNullOrEmpty(u.UserImage))
								{
									<img src="~/images/@u.UserImage" alt="@u.UserName" />
								}
								else
								{
									<i class="bi bi-person-circle"></i>
								}
							</div>
							<div class="user-info">
								<div class="user-name">@u.UserName</div>
								<div class="user-stats">
									<span class="stat-item">
										<i class="bi bi-bag-check"></i>
										@u.OrdersCount orders
									</span>
									<span class="stat-item">
										<i class="bi bi-currency-dollar"></i>
										@u.TotalSpent.ToString("N0") L.E
									</span>
								</div>
							</div>
							<i class="bi bi-chevron-right arrow-icon"></i>
						</a>
						rank++;
					}
				}
				else
				{
					<div class="no-data">
						<i class="bi bi-inbox"></i>
						<p>No users data available</p>
					</div>
				}
			</div>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/js/usersAnalysis.js" asp-append-version="true"></script>

<style>
	.stat-card.clickable { cursor: pointer; }
</style>

<script>
	(function () {
		document.addEventListener('DOMContentLoaded', function () {
			var card = document.querySelector('.stat-card.primary.clickable');
			if (!card) return;
			card.addEventListener('click', function () {
				var href = card.getAttribute('data-href');
				if (href) {
					window.location.href = href;
				}
			});
		});
	})();
</script>